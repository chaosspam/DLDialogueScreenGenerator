!function(){let e,t="en_us";const a=15,n={},i=180,o=250,l=[],r={};let d=!1,s=0;const c="https://dlportraits.space/";let u;const f={},g="https://dragalialost.wiki/thumb.php?width=75&f=",p={},m=12;function h(){f.base="",f.offset={x:0,y:0},f.face="",f.mouth=""}async function v(){if(d)return;d=!0;const t=R("editor"),a=R("preview"),r=t.getContext("2d"),s=a.getContext("2d");r.clearRect(0,0,t.width,t.height),s.clearRect(0,0,a.width,a.height),await async function(){n.background||(n.bar=await F("images/bar.png"),n.skipjp=await F("images/skipjp.png"),n.skipzh_tw=await F("images/skipcn.png"),n.skipzh_cn=await F("images/skipcn.png"))}();const c=n.bar,u=j("input[name=font]:checked").value;for(let e=0;e<l.length;e++){let a=l[e];L(r,t.width/2,t.height/2,a)}await async function(e){let t=R("emotion").value;if("none"!==t){let a=j("input[name=emotionside]:checked").value;n[t+="_"+a]||(n[t]=await F("images/"+t+".png"));const l=n[t];L(e,"l"===a?i:e.canvas.width-i,o,{image:l,offsetX:R("emotionOffsetX").value,offsetY:R("emotionOffsetY").value,scale:1})}}(r),r.drawImage(c,0,0),"en_us"!==u&&r.drawImage(n["skip"+u],0,0),function(t,a){const n=e[a],i=R("name").value,o=R("dialogue").value;t.font=`${n.nameSize}px dragalialost${a}`,t.fillStyle="white",t.fillText(i,n.speakerXPos,n.speakerYPos),t.font=`${n.dialogueSize}px dragalialost${a}`,t.fillStyle="#071726";let l=o.split("\n");for(let e=0;e<l.length;e++){let i=n.dialogueXPos,o=n.dialogueYPos+e*n.lineHeight;b(t,a,l[e],n.dialogueSize,i,o)}}(r,u),s.drawImage(t,0,0,a.width,a.height),d=!1}function L(e,t,a,n){scale=parseFloat(n.scale),t=parseFloat(t),a=parseFloat(a),offsetX=parseFloat(n.offsetX),offsetY=-parseFloat(n.offsetY),rotation=parseFloat(n.rotation?n.rotation:0);let i=n.image.naturalWidth*scale,o=n.image.naturalHeight*scale,l=t-i/2+offsetX,r=a-o/2+offsetY;e.translate(t+offsetX,a+offsetY),e.rotate(rotation*Math.PI/180),e.translate(-t-offsetX,-a-offsetY),e.drawImage(n.image,l,r,i,o),e.translate(t+offsetX,a+offsetY),e.rotate(-rotation*Math.PI/180),e.translate(-t-offsetX,-a-offsetY)}function b(e,t,n,i,o,l){let r="",d=0;const s=`${i}px dragalialost${t}`,c=`${a}px dragalialost${t}`;n=n.replace(/\(([^\)]+)\)\{([^\}]+)\}/g,(t,a,u,f,g)=>{r+=n.substring(d,f),e.font=s;let p=o+e.measureText(r).width+e.measureText(a).width/2;e.font=c;let m=p-e.measureText(u).width/2,h=l-i+2;return e.fillText(u,m,h),r+=a,d=f+a.length+u.length+4,a}),e.font=s,e.fillText(n,o,l)}async function E(){this.innerText=e[t].loc.generating;const a=await new Promise(e=>R("editor").toBlob(e,"image/png"));this.innerText=e[t].loc.download,R("downloadLink").href=URL.createObjectURL(a),R("downloadLink").click()}function w(a,n){const i=x();let o=document.createElement("li");o.innerText=a,o.dataset.layerId=i,o.draggable=!0,o.addEventListener("dragstart",()=>{o.classList.add("dragging")}),o.addEventListener("dragend",()=>{o.classList.remove("dragging"),T(o)}),o.addEventListener("touchstart",e=>{e.preventDefault(),o.classList.add("dragging")}),o.addEventListener("touchend",()=>{o.classList.remove("dragging"),T(o)}),o.addEventListener("touchmove",C);let d={id:i,image:null,offsetX:0,offsetY:0,rotation:0,scale:1},s=function(a,n,i){let o=e[t].loc,d=document.createElement("div");d.classList.add("tab");let s=document.createElement("div");s.innerHTML=`<h2>${o.layerImage}</h2><label>${o.reccomendedSize}</label>`;let c=document.createElement("img");c.src=i,c.alt="Layer Image",c.addEventListener("load",v),a.image=c;let u=document.createElement("input");u.type="file",u.accept="image/*",u.addEventListener("change",()=>{c.src=window.URL.createObjectURL(u.files[0])});let f=document.createElement("button");f.classList.add("button","delete"),f.addEventListener("click",function(){if(l.length<=1)return this.innerText=o.noDeleteBaseLayer,void setTimeout(()=>{this.innerText=o.deleteLayer},1e3);r.id=a.id,r.tabButton=n,r.tab=d,R("deletePrompt").classList.remove("hidden")}),f.innerText=o.deleteLayer,s.appendChild(c),s.appendChild(u),s.appendChild(f),s.appendChild(function(){let a=document.createElement("button");return a.innerText=e[t].loc.fromPortrait,a.addEventListener("click",X),a.classList.add("button"),a.classList.add("portrait-button"),a}()),s.appendChild(function(){let a=document.createElement("button");return a.innerText=e[t].loc.fromBackground,a.classList.add("button"),a.classList.add("bg-button"),a.addEventListener("click",$),a}());let g=document.createElement("div"),p=document.createElement("div"),m=document.createElement("label"),h=document.createElement("input");h.addEventListener("input",function(){n.innerText=this.value}),h.type="text",h.placeholder=o.layerName,h.value=n.innerText,p.appendChild(m),p.appendChild(h),g.appendChild(p),g.appendChild(I(o.layerOffsetX,-400,400,1,0,e=>{a.offsetX=e,v()})),g.appendChild(I(o.layerOffsetY,-400,400,1,0,e=>{a.offsetY=e,v()})),g.appendChild(I(o.layerRotation,-180,180,.1,0,e=>{a.rotation=e,v()}));let L=I(o.layerScale,0,3,.1,1,e=>{a.scale=e,v()}),b=document.createElement("button");return b.classList.add("button"),b.innerText=o.auto,b.addEventListener("click",()=>{let e=R("editor").width/c.naturalWidth,t=L.querySelector("input[type=number]");L.querySelector("input[type=range]").value=e,t.value=e,t.dispatchEvent(new Event("change"))}),L.appendChild(b),g.appendChild(L),d.appendChild(s),d.appendChild(g),d}(d,o,n);o.addEventListener("click",function(){D("#tabBar li").forEach(e=>e.classList.remove("active")),D(".tab").forEach(e=>e.classList.remove("active")),this.classList.add("active"),s.classList.add("active"),R("portraitPanel").classList.add("hidden"),R("backgroundPanel").classList.add("hidden"),R("portraitCharacter").value="",R("facialExpression").innerHTML="",R("mouthExpression").innerHTML="",D(".tab .portrait-button").forEach(e=>e.classList.remove("selected")),D(".tab .bg-button").forEach(e=>e.classList.remove("selected")),h()}),D("#tabBar li").forEach(e=>e.classList.remove("active")),D(".tab").forEach(e=>e.classList.remove("active")),o.classList.add("active"),s.classList.add("active"),R("tabBar").insertBefore(o,R("addLayer")),R("tabs").appendChild(s),l.push(d)}function y(){const e=l.findIndex(e=>e.id===r.id);e>-1&&l.splice(e,1),r.tabButton&&r.tabButton.remove(),r.tab&&r.tab.remove(),j("#tabBar li").click(),v(),P()}function x(){return++s}function k(e){e.preventDefault();const t=B(e.clientX,e.clientY),a=j(".dragging");null==t?R("tabBar").insertBefore(a,R("addLayer")):R("tabBar").insertBefore(a,t)}function C(e){e.preventDefault();let t=e.targetTouches[0];const a=B(t.pageX,t.pageY),n=j(".dragging");null==a?R("tabBar").insertBefore(n,R("addLayer")):R("tabBar").insertBefore(n,a)}function B(e,t){const a=[...D("#tabBar li:not(#addLayer, .dragging)")];let n=null,i=-1,o=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,r=0,d=0;for(let e=0;e<a.length;e++){const t=a[e].getBoundingClientRect(),n=t.top+t.height/2;n>r&&(r=n)}for(let r=0;r<a.length;r++){const s=a[r],c=s.getBoundingClientRect(),u=e-(c.right-c.width/2),f=t-c.bottom;f<0&&-f<=l&&(l=Math.abs(f),u<0?-u<o&&(n=s,o=-u):c.right>d&&(d=c.right,i=r+1))}return null===n&&i>=0&&i<a.length-1&&(n=a[i]),n}function T(e){const t=[...D("#tabBar li:not(#addLayer)")];if(t.length!==l.length)return;let a=function(e){let t=parseInt(e);return l.findIndex(e=>e.id===t)}(e.dataset.layerId),n=t.indexOf(e);-1!==a&&-1!==n?(l.splice(n,0,l.splice(a,1)[0]),v()):console.error(`Cannot move tab from index ${a} to ${n}`)}function I(e,t,a,n,i,o){let l=document.createElement("div"),r=document.createElement("label");r.innerText=e;let d=document.createElement("div");d.classList.add("input-group");let s=document.createElement("input");s.type="number",s.min=t,s.max=a,s.step=n,s.value=i;let c=document.createElement("input");return c.type="range",c.min=t,c.max=a,c.step=n,c.value=i,d.appendChild(s),d.appendChild(c),l.appendChild(r),l.appendChild(d),N(c,s),s.addEventListener("change",function(){o(parseFloat(this.value))}),l}function P(){R("deletePrompt").classList.add("hidden")}function $(){let e=R("backgroundPanel").classList.toggle("hidden");this.classList.toggle("selected",!e),e||(R("portraitPanel").classList.add("hidden"),j(".tab.active .portrait-button").classList.remove("selected"))}function S(e,t,a){let n=[],i=document.createElement("button"),o=document.createElement("button");i.innerText="<",o.innerText=">",i.classList.add("button"),o.classList.add("button");let l=document.createElement("div");l.classList.add("bg-container");for(let e=0;e<a;e++){let a=document.createElement("img");e<t.imgs.length?(a.src=`https://dragalialost.wiki/thumb.php?f=${t.imgs[e].fileName}&width=75`,a.dataset.fullSrc=t.imgs[e].url):a.classList.add("hidden"),a.addEventListener("click",function(){let e=j(".tab.active img");e.crossOrigin="anonymous",e.src=this.dataset.fullSrc}),n.push(a),l.appendChild(a)}i.addEventListener("click",()=>{t.index-=a,t.index<0&&(t.index=0),Y(n,t)}),o.addEventListener("click",()=>{t.index+a>=t.imgs.length||(t.index+=a,Y(n,t))}),e.appendChild(i),e.appendChild(l),e.appendChild(o)}function Y(e,t){for(let a=0;a<e.length;a++){let n=a+t.index;n<t.imgs.length?(e[a].src=g+t.imgs[n].fileName,e[a].dataset.fullSrc=t.imgs[n].url,e[a].classList.remove("hidden")):e[a].classList.add("hidden")}}function X(){let e=R("portraitPanel").classList.toggle("hidden");this.classList.toggle("selected",!e),e||(R("backgroundPanel").classList.add("hidden"),j(".tab.active .bg-button").classList.remove("selected"))}function _(){let e=document.querySelector(`#portraitList option[value="${this.value}"]`);null===e?this.value="":async function(e){let t=await z(c+`portrait_output/${e}/data.json`),a=R("facialExpression");a.innerHTML="";for(let e=0;e<t.partsData.faceParts.length;e++){let n=c+t.partsData.faceParts[e].substring(2),i=document.createElement("img");i.src=n,i.addEventListener("click",function(){f.face=this.src,O()}),a.appendChild(i)}let n=R("mouthExpression");n.innerHTML="";for(let e=0;e<t.partsData.mouthParts.length;e++){let a=c+t.partsData.mouthParts[e].substring(2),i=document.createElement("img");i.src=a,i.addEventListener("click",function(){f.mouth=this.src,O()}),n.appendChild(i)}f.face="",f.mouth="",f.base=c+`portrait_output/${e}/${e}_base.png`,f.offset=t.offset,O()}(e.dataset.id)}async function O(){const e=u.getContext("2d");e.clearRect(0,0,u.width,u.height);const t=await F(f.base);if(e.drawImage(t,0,0),""!==f.face){const t=await F(f.face);e.drawImage(t,f.offset.x,f.offset.y)}if(""!==f.mouth){const t=await F(f.mouth);e.drawImage(t,f.offset.x,f.offset.y)}const a=await new Promise(e=>u.toBlob(e)),n=URL.createObjectURL(a);j(".tab.active img").src=n}function R(e){return document.getElementById(e)}function j(e){return document.querySelector(e)}function D(e){return document.querySelectorAll(e)}async function z(e){try{let t=await fetch(e);if(t.ok){return await t.json()}throw new error(await t.text())}catch(e){console.error(e)}}function F(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((e,a)=>{t.onload=(()=>e(t)),t.onerror=a})}function N(e,t){e.addEventListener("input",function(){t.value=this.value}),e.addEventListener("change",function(){t.dispatchEvent(new Event("change"))}),t.addEventListener("input",function(){e.value=this.value})}window.addEventListener("load",async function(){try{e=await z("data/i18n.json"),t=document.documentElement.lang,w(e[t].loc.background,"images/exampleBackground.png"),w(e[t].loc.portrait,e[t].loc.defaultPortraitSrc),await document.fonts.load("30px dragalialosten"),await document.fonts.load("30px dragalialostjp"),await document.fonts.load("30px dragalialostzh_tw"),await document.fonts.load("30px dragalialostzh_cn"),await v(),(u=document.createElement("canvas")).width=1024,u.height=1024,h(),await async function(){let e=await z("data/background_data.json");for(let t=0;t<e.length;t++)void 0===p[e[t].type]&&(p[e[t].type]={imgs:[],index:0}),p[e[t].type].imgs.push(e[t]);S(R("backgroundBackgroundArt"),p.background,m),S(R("skyboxBackgroundArt"),p.skybox,m),S(R("cloudBackgroundArt"),p.cloud,m),S(R("overlayBackgroundArt"),p.overlay,m)}(),await async function(){let e=await z(c+"portrait_output/localizedDirData.json"),a=R("portraitList");for(file in e.fileList){let n=document.createElement("option");n.value=e.fileList[file][t],n.dataset.id=file,a.appendChild(n)}R("portraitCharacter").addEventListener("change",_)}()}catch(e){console.error(e)}R("addLayer").addEventListener("click",()=>{w(`${e[t].loc.layer} ${l.length}`,"images/adPortrait.png")}),R("name").addEventListener("change",v),R("dialogue").addEventListener("change",v),R("emotion").addEventListener("change",v),D("#dialogueArea input[type=radio]").forEach(e=>e.addEventListener("change",v)),D("#dialogueArea input[type=number]").forEach(e=>{N(j(`[data-slider="${e.id}"]`),e),e.addEventListener("change",v)}),R("deleteConfirmBtn").addEventListener("click",y),R("deleteCancelBtn").addEventListener("click",P),window.addEventListener("dragover",k),document.addEventListener("keydown",function(e){"Escape"===e.key&&P()}),R("download").addEventListener("click",E)})}();